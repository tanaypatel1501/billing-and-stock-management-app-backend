name: Deploy to Oracle Cloud

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      matrix:
        server_alias: [ "VM2", "VM1" ]

    steps:
      - name: Deploy to ${{ matrix.server_alias }} via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ matrix.server_alias == 'VM1' && secrets.OCI_HOST_VM1 || secrets.OCI_HOST_VM2 }}
          username: opc
          key: ${{ secrets.OCI_SSH_KEY }}
          script: |
            # 1. Navigate to directory
            cd ~/billing-and-stock-management-app-backend
            
            # 2. Update code
            echo "Pulling latest code on ${{ matrix.server_alias }}..."
            git pull origin master
            
            # 3. Build with LOW PRIORITY (Prevents the 1-core CPU from freezing)
            echo "Building Docker image..."
            sudo nice -n 19 docker build -t billing-app .
            
            # 4. Stop and remove old container
            sudo docker stop billing-backend || true
            sudo docker rm billing-backend || true
            
            # 5. Run with the "3-Hour Freeze" Fix (SerialGC + RAM limits)
            sudo docker run -d \
              --name billing-backend \
              -p 127.0.0.1:8080:8080 \
              --env-file .env \
              --restart always \
              -e "JAVA_OPTS=-Xmx220m -Xms128m -XX:+UseSerialGC -XX:MaxDirectMemorySize=32m -Xss256k" \
              --log-opt max-size=10m --log-opt max-file=3 \
              billing-app
            
            # 6. Reload Nginx (Only happens on VM1)
            if command -v nginx > /dev/null; then
                sudo systemctl reload nginx
            fi
            
            sudo docker image prune -f
            
            # 7. --- Detailed Health Check ---
            echo "Waiting for Spring Boot to start..."
            attempt_counter=0
            max_attempts=30 

            until $(curl --output /dev/null --silent --head --fail http://127.0.0.1:8080/health-check/server); do
                if [ ${attempt_counter} -eq ${max_attempts} ]; then
                  echo "ERROR: Backend failed on ${{ matrix.server_alias }}."
                  sudo docker logs --tail 50 billing-backend
                  exit 1
                fi
                printf '.'
                attempt_counter=$(($attempt_counter+1))
                sleep 5
            done
            echo "SUCCESS: ${{ matrix.server_alias }} is UP and ACTIVE."