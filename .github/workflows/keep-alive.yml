name: Keep Backend Alive

on:
  schedule:
    # Every 14 minutes (UTC)
    - cron: "*/14 * * * *"

    # Once daily at 7:00 AM IST (01:30 UTC)
    - cron: "30 1 * * *"

  workflow_dispatch:

jobs:
  ping-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Check IST Time Window
        id: timecheck
        run: |
          IST_HOUR=$(TZ=Asia/Kolkata date +%H)

          echo "Current IST hour: $IST_HOUR"

          # Allowed window:
          # 07:00–23:59 IST
          # 00:00–01:59 IST
          if [ "$IST_HOUR" -ge 7 ] || [ "$IST_HOUR" -le 1 ]; then
            echo "run_ping=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_ping=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Ping App Server Health (No DB)
        if: steps.timecheck.outputs.run_ping == 'true'
        run: |
          curl -fsS --max-time 5 \
          https://billing-and-stock-management-app-backend.onrender.com/health-check/server

      - name: Ping DB Health (Once Daily)
        if: github.event.schedule == '30 1 * * *'
        run: |
          curl -fsS --max-time 10 \
          https://billing-and-stock-management-app-backend.onrender.com/health-check/db-server
